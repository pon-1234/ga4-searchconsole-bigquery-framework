# Looker Studioにおける CTR/CVR の正確な集計方法

## 問題

Looker Studioでは、CTR（クリック率）やCVR（コンバージョン率）のようなパーセント指標を集計する際に、以下のような問題が発生することがあります：

1. 全期間の実際のCTRが14.7%であるにも関わらず、Looker Studioでは263%と表示される
2. 日別のCTR/CVRを単純に平均すると、実際の値とは大きく異なる結果になる
3. `/kanto-winter/`ページのCTRが13.64%であるにも関わらず、1364%と表示される

## 原因

この問題が発生する主な原因は以下の通りです：

1. **集計方法の不適切な選択**：
   - 「平均値」を選択すると、各日のCTR/CVRの単純平均を計算し、正確な値を反映しない
   - CTRはクリック数÷インプレッション数、CVRはコンバージョン数÷セッション数で計算されるため、単純な平均は不適切

2. **表示設定の問題**：
   - 「100を掛ける」オプションが有効になっている場合、既にパーセント値のデータがさらに100倍される

## CTRとCVRの定義

当プロジェクトでの定義：

1. **CTR（クリック率）**:
   ```sql
   ROUND(100.0 * SUM(clicks) / SUM(impressions), 2)
   ```

2. **CVR（コンバージョン率）**:
   ```sql
   ROUND(100.0 * SUM(purchase_count) / SUM(sessions), 2)
   ```

## 最適な集計方法

与えられた集計オプションの中では、CTR/CVRには「**なし**」が最も適切です：

- **なし**: 集計前のデータをそのまま使用（ただし、別途カスタム計算を行う必要あり）
- **合計**: パーセント値の合計は意味がない
- **平均値**: 不正確な結果となる（上記の問題を引き起こす）
- **件数/個別件数/最小値/最大値/中央値/標準偏差/差異**: CTR/CVRの測定には適さない

## 推奨される解決策

### 1. カスタム計算フィールドの作成（最も正確）

#### CTRの場合：
1. データソース編集画面で「フィールドを追加」→「計算フィールドを作成」を選択
2. 名前を「正確なCTR」などと設定
3. 以下の計算式を入力：
   ```
   SUM(clicks) / SUM(impressions) * 100
   ```

#### CVRの場合：
1. 同様にカスタム計算フィールドを作成
2. 名前を「正確なCVR」などと設定
3. 以下の計算式を入力：
   ```
   SUM(purchase_count) / SUM(sessions) * 100
   ```

4. いずれの場合も「数値の書式設定」で「パーセント」を選択（「100を掛ける」はオフ）

### 2. 表示設定の確認

1. データソース設定で `ctr_percent` や `cvr_percent` フィールドを編集
2. 「タイプと書式設定」セクションで以下を確認：
   - 集計方法が適切に設定されている（「なし」または上記のカスタム計算）
   - 「100を掛ける」オプションがオフになっている

### 3. レポートレベルでの設定

1. 各チャートやテーブルの設定で、集計方法が適切に設定されているか確認
2. 必要に応じて、ディメンションとメトリクスの設定を調整

## 実例

以下は、BigQueryの実際のデータに基づく例です：

### 例1: `/kanto-train/` ページの2025年2月データ

**BigQueryの実データ**:
- 総インプレッション: 7,675
- 総クリック: 1,128
- 正確なCTR: 14.7%

**Looker Studioでの誤った表示**:
- CTR: 263%（日別CTRの単純平均による）

### 例2: `/kanto-winter/` ページの2025年1月8日データ

**BigQueryの実データ**:
- インプレッション: 528
- クリック: 72
- 正確なCTR: 13.64%

**Looker Studioでの誤った表示**:
- CTR: 1364%（表示設定の問題）

このような不一致は、適切な集計方法を選択することで解決できます。 